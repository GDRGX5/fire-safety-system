<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="theme-color" content="#ff4757">
    <title>æ¶ˆé˜²å“¡æ§åˆ¶å°</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--safe:#2ed573;--help:#ff4757;--trapped:#ffa502;--unknown:#747d8c;--bg:#0f0f1a;--card:#1a1a2e;--text:#fff;--review:#9b59b6;}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:12px;padding-bottom:80px;}
        .hdr{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:16px;}
        .hdr a{color:var(--text);text-decoration:none;font-size:26px;padding:8px}
        .hdr h1{flex:1;font-size:16px;display:flex;align-items:center;gap:8px}
        .hdr .live{background:var(--help);padding:4px 10px;border-radius:4px;font-size:11px;font-weight:bold;animation:blink 1.5s infinite;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
        .hdr .refresh{font-size:22px;padding:8px;cursor:pointer}
        .summary{background:linear-gradient(135deg,#c0392b,#e74c3c);border-radius:14px;padding:16px;margin-bottom:16px;}
        .summary-title{font-size:14px;font-weight:bold;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
        .summary-stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
        .summary-stat{background:rgba(0,0,0,0.25);border-radius:10px;padding:10px 6px;text-align:center;}
        .summary-stat .num{font-size:24px;font-weight:bold}
        .summary-stat .label{font-size:9px;opacity:0.9;margin-top:2px}
        .summary-stat.urgent{border:2px solid var(--trapped)}
        .summary-stat.review{border:2px solid var(--review)}
        .filter-tabs{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;}
        .filter-tab{padding:10px 14px;background:var(--card);border:none;border-radius:8px;color:var(--text);font-size:12px;white-space:nowrap;cursor:pointer;}
        .filter-tab.active{font-weight:bold}
        .filter-tab.trapped.active{background:var(--trapped);color:#000}
        .filter-tab.help.active{background:var(--help)}
        .filter-tab.safe.active{background:var(--safe);color:#000}
        .filter-tab.review.active{background:var(--review)}
        .rescue-list{display:flex;flex-direction:column;gap:12px}
        .rescue-card{background:var(--card);border-radius:14px;padding:16px;border-left:5px solid var(--unknown);}
        .rescue-card.trapped{border-left-color:var(--trapped)}
        .rescue-card.help{border-left-color:var(--help)}
        .rescue-card.safe{border-left-color:var(--safe)}
        .rescue-card.review{border-left-color:var(--review);background:rgba(155,89,182,0.1);}
        .rescue-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
        .rescue-location{font-size:17px;font-weight:bold}
        .rescue-badges{display:flex;gap:6px;flex-wrap:wrap;}
        .rescue-priority{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:bold;}
        .rescue-priority.trapped{background:var(--trapped);color:#000}
        .rescue-priority.help{background:var(--help)}
        .rescue-priority.safe{background:var(--safe);color:#000}
        .rescue-priority.review{background:var(--review)}
        .rescue-meta{display:flex;gap:12px;font-size:12px;opacity:0.8;margin-bottom:10px;flex-wrap:wrap;}
        .rescue-note{padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px;margin-bottom:12px;}
        .rescue-photo{width:100%;max-height:160px;object-fit:cover;border-radius:8px;margin-bottom:12px;cursor:pointer;}
        .rescue-actions{display:flex;gap:8px;flex-wrap:wrap;}
        .rescue-actions button{flex:1;min-width:80px;padding:12px 8px;border:none;border-radius:8px;font-size:13px;font-weight:bold;cursor:pointer;}
        .btn-rescued{background:var(--safe);color:#000}
        .btn-navigate{background:rgba(255,255,255,0.12);color:var(--text)}
        .btn-verify{background:var(--review);color:#fff}
        .btn-edit{background:rgba(255,165,2,0.3);color:var(--trapped)}
        .empty{text-align:center;padding:40px 20px;opacity:0.6;}
        .empty .icon{font-size:52px;margin-bottom:12px}
        .toolbar{position:fixed;bottom:0;left:0;right:0;display:flex;gap:6px;padding:12px 12px;background:linear-gradient(transparent,var(--bg) 30%);padding-top:30px;}
        .toolbar button{flex:1;padding:12px 6px;background:var(--card);border:none;border-radius:10px;color:var(--text);font-size:11px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;}
        .toolbar button span{font-size:18px}
        .photo-modal{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:2000;}
        .photo-modal.show{display:flex}
        .photo-modal img{max-width:100%;max-height:100%;object-fit:contain}
        .photo-modal .close{position:absolute;top:20px;right:20px;width:48px;height:48px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;color:#fff;font-size:26px;cursor:pointer;}
        /* ç·¨è¼¯å½ˆçª— */
        .edit-modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:1500;padding:16px;}
        .edit-modal.show{display:flex}
        .edit-content{background:var(--card);border-radius:16px;padding:20px;max-width:400px;width:100%;max-height:90vh;overflow-y:auto;}
        .edit-content h3{margin-bottom:16px;font-size:18px;}
        .edit-field{margin-bottom:14px;}
        .edit-field label{display:block;font-size:12px;opacity:0.7;margin-bottom:4px;}
        .edit-field input,.edit-field select{width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.08);color:var(--text);font-size:16px;}
        .edit-field input:focus,.edit-field select:focus{border-color:var(--safe);outline:none;}
        .edit-btns{display:flex;gap:10px;margin-top:20px;}
        .edit-btns button{flex:1;padding:14px;border:none;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;}
        .edit-btns .save{background:var(--safe);color:#000}
        .edit-btns .cancel{background:rgba(255,255,255,0.1);color:#fff}
        /* æ‰‹å‹•æ–°å¢ */
        .add-section{background:var(--card);border-radius:14px;padding:16px;margin-bottom:16px;display:none;}
        .add-section.show{display:block}
        .add-section h3{margin-bottom:12px;font-size:15px;}
    </style>
</head>
<body>
    <header class="hdr">
        <a href="index.html">â†</a>
        <h1>ğŸ‘¨â€ğŸš’ æ•‘æ´æ§åˆ¶å° <span class="live">LIVE</span></h1>
        <span class="refresh" onclick="loadReports()">ğŸ”„</span>
    </header>

    <section class="summary">
        <div class="summary-title">ğŸš¨ ç·Šæ€¥ç‹€æ³æ‘˜è¦</div>
        <div class="summary-stats">
            <div class="summary-stat urgent">
                <div class="num" id="statTrapped">0</div>
                <div class="label">è¢«å›°</div>
            </div>
            <div class="summary-stat">
                <div class="num" id="statHelp">0</div>
                <div class="label">éœ€å¹«åŠ©</div>
            </div>
            <div class="summary-stat review">
                <div class="num" id="statReview">0</div>
                <div class="label">å¾…å¯©æ ¸</div>
            </div>
            <div class="summary-stat">
                <div class="num" id="statSafe">0</div>
                <div class="label">å·²å®‰å…¨</div>
            </div>
            <div class="summary-stat">
                <div class="num" id="statTotal">0</div>
                <div class="label">ç¸½å ±å‘Š</div>
            </div>
        </div>
    </section>

    <div class="filter-tabs">
        <button class="filter-tab trapped active" onclick="setFilter('trapped')">ğŸš¨ è¢«å›° (<span id="tabTrapped">0</span>)</button>
        <button class="filter-tab help" onclick="setFilter('help')">ğŸ†˜ éœ€å¹«åŠ© (<span id="tabHelp">0</span>)</button>
        <button class="filter-tab review" onclick="setFilter('review')">âš ï¸ å¾…å¯©æ ¸ (<span id="tabReview">0</span>)</button>
        <button class="filter-tab safe" onclick="setFilter('safe')">âœ… å®‰å…¨ (<span id="tabSafe">0</span>)</button>
        <button class="filter-tab" onclick="setFilter('all')">å…¨éƒ¨</button>
    </div>

    <!-- æ‰‹å‹•æ–°å¢å€åŸŸ -->
    <section class="add-section" id="addSection">
        <h3>â• æ‰‹å‹•æ–°å¢å ±å‘Š</h3>
        <div class="edit-field">
            <label>å±‹è‹‘</label>
            <input type="text" id="addEstate" placeholder="å±‹è‹‘åç¨±">
        </div>
        <div class="edit-field">
            <label>å¤§å»ˆ</label>
            <input type="text" id="addBuilding" placeholder="å¤§å»ˆ/åº§æ•¸">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="edit-field">
                <label>æ¨“å±¤</label>
                <input type="text" id="addFloor" placeholder="æ¨“å±¤">
            </div>
            <div class="edit-field">
                <label>å–®ä½</label>
                <input type="text" id="addUnit" placeholder="å–®ä½">
            </div>
        </div>
        <div class="edit-field">
            <label>ç‹€æ…‹</label>
            <select id="addStatus">
                <option value="trapped">ğŸš¨ è¢«å›°</option>
                <option value="help">ğŸ†˜ éœ€å¹«åŠ©</option>
                <option value="safe">âœ… å®‰å…¨</option>
            </select>
        </div>
        <div class="edit-field">
            <label>å‚™è¨»</label>
            <input type="text" id="addNote" placeholder="å‚™è¨»ä¿¡æ¯">
        </div>
        <div class="edit-btns">
            <button class="save" onclick="addManualReport()">æ–°å¢å ±å‘Š</button>
            <button class="cancel" onclick="toggleAddSection()">å–æ¶ˆ</button>
        </div>
    </section>

    <section class="rescue-list" id="rescueList">
        <div class="empty">
            <div class="icon">âœ…</div>
            <p>æš«ç„¡éœ€è¦æ•‘æ´çš„å ±å‘Š</p>
        </div>
    </section>

    <div class="toolbar">
        <button onclick="toggleAddSection()"><span>â•</span>æ–°å¢</button>
        <button onclick="exportCSV()"><span>ğŸ“Š</span>å°å‡ºCSV</button>
        <button onclick="exportJSON()"><span>ğŸ“„</span>å°å‡ºJSON</button>
        <button onclick="generateDemo()"><span>ğŸ”§</span>æ¸¬è©¦æ•¸æ“š</button>
        <button onclick="clearAll()"><span>ğŸ—‘ï¸</span>æ¸…é™¤</button>
    </div>

    <div class="photo-modal" id="photoModal" onclick="closePhoto()">
        <img id="photoImg" src="">
        <button class="close">Ã—</button>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div class="edit-modal" id="editModal">
        <div class="edit-content">
            <h3>âœï¸ ç·¨è¼¯/é©—è­‰å ±å‘Š</h3>
            <input type="hidden" id="editId">
            <div class="edit-field">
                <label>å±‹è‹‘</label>
                <select id="editEstateKey">
                    <option value="">-- é¸æ“‡å·²çŸ¥å±‹è‹‘ --</option>
                </select>
            </div>
            <div class="edit-field">
                <label>å±‹è‹‘åç¨±ï¼ˆè‡ªè¨‚ï¼‰</label>
                <input type="text" id="editEstate">
            </div>
            <div class="edit-field">
                <label>å¤§å»ˆ</label>
                <input type="text" id="editBuilding">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="edit-field">
                    <label>æ¨“å±¤</label>
                    <input type="text" id="editFloor">
                </div>
                <div class="edit-field">
                    <label>å–®ä½</label>
                    <input type="text" id="editUnit">
                </div>
            </div>
            <div class="edit-field">
                <label>ç‹€æ…‹</label>
                <select id="editStatus">
                    <option value="trapped">ğŸš¨ è¢«å›°</option>
                    <option value="help">ğŸ†˜ éœ€å¹«åŠ©</option>
                    <option value="safe">âœ… å®‰å…¨</option>
                </select>
            </div>
            <div class="edit-field">
                <label>å‚™è¨»</label>
                <input type="text" id="editNote">
            </div>
            <div class="edit-btns">
                <button class="save" onclick="saveEdit()">ä¿å­˜ä¸¦é©—è­‰</button>
                <button class="cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="estates-data.js"></script>
    <script>
    let allReports = [];
    let currentFilter = 'trapped';

    document.addEventListener('DOMContentLoaded', function() {
        loadReports();
        populateEstateSelect();
        
        if ('BroadcastChannel' in window) {
            const ch = new BroadcastChannel('fire_safety_sync');
            ch.onmessage = (e) => {
                if (e.data.type === 'new_report' || e.data.type === 'estates_updated') {
                    loadReports();
                }
            };
        }
        
        setInterval(loadReports, 5000);
    });

    function populateEstateSelect() {
        const select = document.getElementById('editEstateKey');
        const estates = window.estatesManager.getAllEstates();
        select.innerHTML = '<option value="">-- é¸æ“‡å·²çŸ¥å±‹è‹‘ --</option>';
        for (const [key, estate] of Object.entries(estates)) {
            select.innerHTML += `<option value="${key}">${estate.name}</option>`;
        }
    }

    function loadReports() {
        allReports = JSON.parse(localStorage.getItem('fire_reports') || '[]');
        updateStats();
        renderList();
    }

    function updateStats() {
        const trapped = allReports.filter(r => r.status === 'trapped').length;
        const help = allReports.filter(r => r.status === 'help').length;
        const safe = allReports.filter(r => r.status === 'safe').length;
        const review = allReports.filter(r => r.needsManualReview && !r.verified).length;
        
        document.getElementById('statTrapped').textContent = trapped;
        document.getElementById('statHelp').textContent = help;
        document.getElementById('statSafe').textContent = safe;
        document.getElementById('statReview').textContent = review;
        document.getElementById('statTotal').textContent = allReports.length;
        
        document.getElementById('tabTrapped').textContent = trapped;
        document.getElementById('tabHelp').textContent = help;
        document.getElementById('tabSafe').textContent = safe;
        document.getElementById('tabReview').textContent = review;
    }

    function setFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        renderList();
    }

    function renderList() {
        const container = document.getElementById('rescueList');
        
        let filtered = allReports;
        if (currentFilter === 'review') {
            filtered = allReports.filter(r => r.needsManualReview && !r.verified);
        } else if (currentFilter !== 'all') {
            filtered = allReports.filter(r => r.status === currentFilter);
        }
        
        filtered.sort((a, b) => {
            // å¾…å¯©æ ¸å„ªå…ˆ
            if ((a.needsManualReview && !a.verified) !== (b.needsManualReview && !b.verified)) {
                return (a.needsManualReview && !a.verified) ? -1 : 1;
            }
            const priorityOrder = { trapped: 0, help: 1, safe: 2 };
            if (priorityOrder[a.status] !== priorityOrder[b.status]) {
                return priorityOrder[a.status] - priorityOrder[b.status];
            }
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">âœ…</div><p>æ­¤é¡åˆ¥æš«ç„¡å ±å‘Š</p></div>';
            return;
        }
        
        container.innerHTML = filtered.map((r, i) => {
            const statusText = { safe: 'å®‰å…¨', trapped: 'è¢«å›°ä¸­', help: 'éœ€å¹«åŠ©' };
            const waitTime = getWaitTime(r.timestamp);
            const time = new Date(r.timestamp).toLocaleTimeString('zh-HK', { hour:'2-digit', minute:'2-digit' });
            const needsReview = r.needsManualReview && !r.verified;
            const cardClass = needsReview ? 'review' : r.status;
            
            return `
                <div class="rescue-card ${cardClass}">
                    <div class="rescue-header">
                        <div class="rescue-location">${r.building} ${r.floor}æ¨“ ${r.unit}å®¤</div>
                        <div class="rescue-badges">
                            <span class="rescue-priority ${r.status}">${statusText[r.status]}</span>
                            ${needsReview ? '<span class="rescue-priority review">å¾…å¯©æ ¸</span>' : ''}
                            ${r.verified ? '<span class="rescue-priority" style="background:#27ae60">âœ“å·²é©—è­‰</span>' : ''}
                        </div>
                    </div>
                    <div class="rescue-meta">
                        <span>ğŸ“ ${r.estate}</span>
                        <span>â±ï¸ ç­‰å¾… ${waitTime}</span>
                        <span>ğŸ• ${time}</span>
                        ${r.phone ? `<span>ğŸ“ ${r.phone}</span>` : ''}
                        ${r.matched ? '<span style="color:var(--safe)">âœ“å·²åŒ¹é…</span>' : '<span style="color:var(--trapped)">âš æœªåŒ¹é…</span>'}
                    </div>
                    ${r.note ? `<div class="rescue-note">ğŸ“ ${r.note}</div>` : ''}
                    ${r.photo ? `<img class="rescue-photo" src="${r.photo}" alt="ç¾å ´" onclick="showPhoto('${r.id}')">` : ''}
                    <div class="rescue-actions">
                        <button class="btn-rescued" onclick="markRescued(${r.id})">âœ… å·²æ•‘æ´</button>
                        <button class="btn-edit" onclick="openEditModal(${r.id})">âœï¸ ç·¨è¼¯</button>
                        ${needsReview ? `<button class="btn-verify" onclick="verifyReport(${r.id})">âœ“ ç¢ºèªä½ç½®</button>` : ''}
                        <button class="btn-navigate" onclick="navigate('${r.estate}','${r.building}')">ğŸ“ å°èˆª</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getWaitTime(timestamp) {
        const diff = Date.now() - new Date(timestamp).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'å‰›å‰›';
        if (mins < 60) return `${mins}åˆ†é˜`;
        const hours = Math.floor(mins / 60);
        return `${hours}å°æ™‚${mins % 60}åˆ†`;
    }

    function markRescued(reportId) {
        const index = allReports.findIndex(r => r.id === reportId);
        if (index >= 0) {
            allReports[index].status = 'safe';
            allReports[index].note = (allReports[index].note || '') + ' [å·²æ•‘æ´]';
            allReports[index].verified = true;
            allReports[index].verifiedAt = new Date().toISOString();
            saveReports();
            loadReports();
            alert('âœ… å·²æ¨™è¨˜ç‚ºå·²æ•‘æ´');
        }
    }

    function verifyReport(reportId) {
        const index = allReports.findIndex(r => r.id === reportId);
        if (index >= 0) {
            allReports[index].verified = true;
            allReports[index].needsManualReview = false;
            allReports[index].verifiedAt = new Date().toISOString();
            allReports[index].verifiedBy = 'æ¶ˆé˜²å“¡';
            saveReports();
            loadReports();
            alert('âœ… å·²ç¢ºèªä½ç½®è³‡æ–™');
        }
    }

    function openEditModal(reportId) {
        const report = allReports.find(r => r.id === reportId);
        if (!report) return;
        
        document.getElementById('editId').value = reportId;
        document.getElementById('editEstateKey').value = report.estateKey || '';
        document.getElementById('editEstate').value = report.estate || '';
        document.getElementById('editBuilding').value = report.building || '';
        document.getElementById('editFloor').value = report.floor || '';
        document.getElementById('editUnit').value = report.unit || '';
        document.getElementById('editStatus').value = report.status || 'help';
        document.getElementById('editNote').value = report.note || '';
        
        document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
    }

    function saveEdit() {
        const reportId = parseInt(document.getElementById('editId').value);
        const index = allReports.findIndex(r => r.id === reportId);
        if (index < 0) return;
        
        const estateKey = document.getElementById('editEstateKey').value;
        const estate = document.getElementById('editEstate').value.trim();
        
        allReports[index].estateKey = estateKey || null;
        allReports[index].estate = estate || (estateKey ? window.estatesManager.getEstate(estateKey)?.name : '');
        allReports[index].building = document.getElementById('editBuilding').value.trim();
        allReports[index].floor = document.getElementById('editFloor').value.trim();
        allReports[index].unit = document.getElementById('editUnit').value.trim();
        allReports[index].status = document.getElementById('editStatus').value;
        allReports[index].note = document.getElementById('editNote').value.trim();
        allReports[index].verified = true;
        allReports[index].needsManualReview = false;
        allReports[index].verifiedAt = new Date().toISOString();
        allReports[index].verifiedBy = 'æ¶ˆé˜²å“¡';
        
        // é‡æ–°é©—è­‰åŒ¹é…
        if (estateKey) {
            const result = window.estatesManager.validateLocation(
                estateKey, 
                allReports[index].building, 
                allReports[index].floor, 
                allReports[index].unit
            );
            allReports[index].matched = result.valid;
        }
        
        saveReports();
        closeEditModal();
        loadReports();
        alert('âœ… å ±å‘Šå·²æ›´æ–°ä¸¦é©—è­‰');
    }

    function toggleAddSection() {
        document.getElementById('addSection').classList.toggle('show');
    }

    function addManualReport() {
        const estate = document.getElementById('addEstate').value.trim();
        const building = document.getElementById('addBuilding').value.trim();
        const floor = document.getElementById('addFloor').value.trim();
        const unit = document.getElementById('addUnit').value.trim();
        const status = document.getElementById('addStatus').value;
        const note = document.getElementById('addNote').value.trim();
        
        if (!estate || !floor) {
            alert('è«‹è‡³å°‘å¡«å¯«å±‹è‹‘å’Œæ¨“å±¤');
            return;
        }
        
        // å˜—è©¦åŒ¹é…å±‹è‹‘
        const match = window.estatesManager.matchEstate(estate);
        
        const report = {
            id: Date.now(),
            estate: estate,
            estateKey: match?.key || null,
            building: building || 'æœªæŒ‡å®š',
            floor: floor,
            unit: unit || 'æœªæŒ‡å®š',
            phone: null,
            status: status,
            note: note ? `[äººå·¥æ–°å¢] ${note}` : '[äººå·¥æ–°å¢]',
            photo: null,
            timestamp: new Date().toISOString(),
            synced: true,
            matched: match !== null,
            needsManualReview: false,
            verified: true,
            verifiedBy: 'æ¶ˆé˜²å“¡',
            verifiedAt: new Date().toISOString()
        };
        
        allReports.push(report);
        saveReports();
        
        // æ¸…ç©ºè¡¨å–®
        ['addEstate', 'addBuilding', 'addFloor', 'addUnit', 'addNote'].forEach(id => {
            document.getElementById(id).value = '';
        });
        
        toggleAddSection();
        loadReports();
        alert('âœ… å ±å‘Šå·²æ–°å¢');
    }

    function saveReports() {
        localStorage.setItem('fire_reports', JSON.stringify(allReports));
        if ('BroadcastChannel' in window) {
            new BroadcastChannel('fire_safety_sync').postMessage({type:'updated'});
        }
    }

    function navigate(estate, building) {
        alert(`ğŸ“ å°èˆªè‡³ï¼š${estate} ${building}\n\nï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æœƒæ‰“é–‹åœ°åœ–å°èˆªï¼‰`);
    }

    function showPhoto(reportId) {
        event.stopPropagation();
        const report = allReports.find(r => r.id === parseInt(reportId));
        if (report && report.photo) {
            document.getElementById('photoImg').src = report.photo;
            document.getElementById('photoModal').classList.add('show');
        }
    }

    function closePhoto() {
        document.getElementById('photoModal').classList.remove('show');
    }

    function exportCSV() {
        if (allReports.length === 0) { alert('æ²’æœ‰æ•¸æ“šå¯å°å‡º'); return; }
        const headers = ['ID','ç‹€æ…‹','å±‹è‹‘','å¤§å»ˆ','æ¨“å±¤','å–®ä½','å‚™è¨»','æ™‚é–“','å·²åŒ¹é…','å·²é©—è­‰'];
        const rows = allReports.map(r => [
            r.id,
            r.status === 'safe' ? 'å®‰å…¨' : r.status === 'trapped' ? 'è¢«å›°' : 'éœ€å¹«åŠ©',
            r.estate, r.building, r.floor, r.unit,
            (r.note || '').replace(/,/g, 'ï¼Œ'),
            r.timestamp,
            r.matched ? 'æ˜¯' : 'å¦',
            r.verified ? 'æ˜¯' : 'å¦'
        ]);
        const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
        downloadFile(csv, `fire_report_${getDateStr()}.csv`, 'text/csv;charset=utf-8');
    }

    function exportJSON() {
        if (allReports.length === 0) { alert('æ²’æœ‰æ•¸æ“šå¯å°å‡º'); return; }
        const exportData = allReports.map(r => ({ ...r, photo: r.photo ? '[æœ‰ç…§ç‰‡]' : null }));
        downloadFile(JSON.stringify(exportData, null, 2), `fire_report_${getDateStr()}.json`, 'application/json');
    }

    function downloadFile(content, filename, type) {
        const blob = new Blob(['\ufeff' + content], { type: type + ';charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
    }

    function getDateStr() { return new Date().toISOString().slice(0,10); }

    function generateDemo() {
        const statuses = ['safe','safe','safe','help','help','trapped'];
        const estates = window.estatesManager.getAllEstates();
        const estateKeys = Object.keys(estates);
        const notes = ['','','æœ‰é•·è€…éœ€å”åŠ©','æœ‰å°å­©','éœ€è¼ªæ¤…','ç…™éœ§å¤§ï¼Œå›°åœ¨å»æ‰€','çª—é‚Šæ±‚æ•‘'];
        
        const reports = [];
        for (let i = 0; i < 25; i++) {
            const estateKey = estateKeys[Math.floor(Math.random() * estateKeys.length)];
            const estate = estates[estateKey];
            const building = estate.buildings[Math.floor(Math.random() * estate.buildings.length)];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            const needsReview = Math.random() > 0.7;
            
            reports.push({
                id: Date.now() + i,
                status: status,
                estate: estate.name,
                estateKey: estateKey,
                building: building.name,
                floor: Math.floor(Math.random() * building.floors) + 1,
                unit: building.units[Math.floor(Math.random() * building.units.length)],
                note: notes[Math.floor(Math.random() * notes.length)],
                photo: null,
                timestamp: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                synced: true,
                matched: !needsReview,
                needsManualReview: needsReview,
                verified: !needsReview
            });
        }
        
        localStorage.setItem('fire_reports', JSON.stringify(reports));
        if ('BroadcastChannel' in window) {
            new BroadcastChannel('fire_safety_sync').postMessage({type:'demo'});
        }
        loadReports();
        alert('ğŸ”§ å·²ç”Ÿæˆ 25 ç­†æ¸¬è©¦æ•¸æ“š');
    }

    function clearAll() {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ')) {
            localStorage.removeItem('fire_reports');
            localStorage.removeItem('active_alert');
            if ('BroadcastChannel' in window) {
                new BroadcastChannel('fire_safety_sync').postMessage({type:'clear'});
            }
            loadReports();
            alert('âœ… æ•¸æ“šå·²æ¸…é™¤');
        }
    }
    </script>
</body>
</html>
