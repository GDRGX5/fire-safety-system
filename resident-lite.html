<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="theme-color" content="#ff4757">
    <title>ç·Šæ€¥å ±å¹³å®‰</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--safe:#2ed573;--help:#ff4757;--trapped:#ffa502;--bg:#1a1a2e;--text:#fff;}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:12px;padding-bottom:100px;}
        .hdr{display:flex;align-items:center;padding:8px 0 16px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:16px;}
        .hdr a{color:var(--text);text-decoration:none;font-size:28px;padding:8px;margin-right:8px}
        .hdr h1{font-size:20px;display:flex;align-items:center;gap:8px}
        .hdr .status{margin-left:auto;font-size:12px;padding:4px 10px;border-radius:12px;background:rgba(46,213,115,0.2);}
        .hdr .status.offline{background:rgba(255,71,87,0.2)}
        .offline-bar{background:var(--trapped);color:#000;padding:12px;border-radius:10px;text-align:center;font-weight:bold;margin-bottom:16px;display:none;}
        .offline-bar.show{display:block}
        .section{background:rgba(255,255,255,0.05);border-radius:14px;padding:16px;margin-bottom:16px;}
        .section-title{font-size:15px;font-weight:bold;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
        .section-title .num{width:26px;height:26px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;}
        .input-group{display:flex;flex-direction:column;gap:10px;}
        .input-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
        .input-row.full{grid-template-columns:1fr}
        .input-field{display:flex;flex-direction:column;gap:4px;}
        .input-field label{font-size:12px;opacity:0.7;padding-left:4px;}
        .input-field input{width:100%;padding:14px 12px;border-radius:10px;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.08);color:var(--text);font-size:18px;transition:border-color 0.2s;}
        .input-field input:focus{border-color:var(--safe);outline:none;background:rgba(255,255,255,0.12);}
        .input-field input::placeholder{color:rgba(255,255,255,0.4);font-size:16px;}
        .input-field input.error{border-color:var(--help);}
        .input-field input.success{border-color:var(--safe);}
        .match-hint{font-size:11px;padding:4px 8px;border-radius:6px;margin-top:4px;}
        .match-hint.success{background:rgba(46,213,115,0.2);color:var(--safe);}
        .match-hint.warning{background:rgba(255,165,2,0.2);color:var(--trapped);}
        .match-hint.error{background:rgba(255,71,87,0.2);color:var(--help);}
        .quick-fill{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
        .quick-btn{padding:8px 12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;}
        .quick-btn:active{background:rgba(255,255,255,0.2)}
        .status-btns{display:flex;flex-direction:column;gap:10px;}
        .status-btn{padding:22px 16px;border:3px solid transparent;border-radius:14px;font-size:22px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all 0.15s;opacity:0.65;}
        .status-btn:active{transform:scale(0.98)}
        .status-btn.selected{opacity:1;border-color:#fff;transform:scale(1.02);box-shadow:0 4px 20px rgba(0,0,0,0.3);}
        .btn-safe{background:var(--safe);color:#000}
        .btn-trapped{background:var(--trapped);color:#000}
        .btn-help{background:var(--help);color:#fff}
        .photo-area{display:flex;flex-direction:column;gap:10px}
        #cameraInput{display:none}
        .photo-btn{padding:16px;background:rgba(255,255,255,0.08);border:2px dashed rgba(255,255,255,0.25);border-radius:12px;color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;}
        .photo-preview{display:none;position:relative;}
        .photo-preview.show{display:block}
        .photo-preview img{width:100%;border-radius:10px;max-height:200px;object-fit:cover;}
        .photo-preview .remove{position:absolute;top:8px;right:8px;width:36px;height:36px;background:rgba(0,0,0,0.7);border:none;border-radius:50%;color:#fff;font-size:20px;cursor:pointer;}
        textarea{width:100%;padding:14px;border-radius:10px;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.08);color:var(--text);font-size:16px;resize:none;height:80px;}
        textarea::placeholder{color:rgba(255,255,255,0.4)}
        textarea:focus{border-color:var(--safe);outline:none}
        .submit-container{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;background:linear-gradient(transparent,var(--bg) 30%);padding-top:40px;}
        .submit-btn{width:100%;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:14px;color:#fff;font-size:22px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 20px rgba(102,126,234,0.4);}
        .submit-btn:disabled{opacity:0.4;cursor:not-allowed;box-shadow:none;}
        .submit-btn:not(:disabled):active{transform:scale(0.98)}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;}
        .modal.show{display:flex}
        .modal-content{background:var(--bg);border-radius:20px;padding:32px 24px;text-align:center;max-width:340px;width:100%;animation:popIn 0.3s ease;}
        @keyframes popIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
        .modal-icon{font-size:80px;margin-bottom:16px}
        .modal-title{font-size:24px;font-weight:bold;margin-bottom:10px}
        .modal-msg{font-size:14px;opacity:0.8;margin-bottom:24px;line-height:1.5}
        .modal-btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:17px;font-weight:bold;cursor:pointer;margin-bottom:10px;}
        .modal-btn.primary{background:var(--safe);color:#000}
        .modal-btn.secondary{background:rgba(255,255,255,0.1);color:#fff}
        .hint{font-size:12px;opacity:0.6;margin-top:8px;padding-left:4px;}
    </style>
</head>
<body>
    <header class="hdr">
        <a href="index.html">â†</a>
        <h1>ğŸ”¥ ç·Šæ€¥å ±å¹³å®‰</h1>
        <span class="status" id="netStatus">ğŸŸ¢ åœ¨ç·š</span>
    </header>

    <div class="offline-bar" id="offlineBar">âš ï¸ é›¢ç·šæ¨¡å¼ - å ±å‘Šå°‡åœ¨ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•ç™¼é€</div>

    <section class="section">
        <div class="section-title"><span class="num">1</span> æ‚¨çš„ä½ç½®</div>
        <div class="input-group">
            <div class="input-row full">
                <div class="input-field">
                    <label>å±‹è‹‘/å¤§å»ˆåç¨±</label>
                    <input type="text" id="inputEstate" placeholder="ä¾‹å¦‚ï¼šç¾å­šæ–°é‚¨ã€å¤ªå¤åŸ" autocomplete="off">
                    <div class="match-hint" id="estateHint" style="display:none"></div>
                </div>
            </div>
            <div class="input-row">
                <div class="input-field">
                    <label>åº§æ•¸/å¤§å»ˆ</label>
                    <input type="text" id="inputBuilding" placeholder="ä¾‹å¦‚ï¼šç¬¬3åº§ã€æ±å±±é–£" autocomplete="off">
                    <div class="match-hint" id="buildingHint" style="display:none"></div>
                </div>
                <div class="input-field">
                    <label>æ¨“å±¤</label>
                    <input type="text" id="inputFloor" placeholder="ä¾‹å¦‚ï¼š15ã€15æ¨“" inputmode="numeric" autocomplete="off">
                    <div class="match-hint" id="floorHint" style="display:none"></div>
                </div>
            </div>
            <div class="input-row">
                <div class="input-field">
                    <label>å–®ä½</label>
                    <input type="text" id="inputUnit" placeholder="ä¾‹å¦‚ï¼šAã€Aå®¤ã€1è™Ÿ" autocomplete="off">
                </div>
                <div class="input-field">
                    <label>è¯çµ¡é›»è©±ï¼ˆé¸å¡«ï¼‰</label>
                    <input type="tel" id="inputPhone" placeholder="ä¾‹å¦‚ï¼š9123 4567" autocomplete="off">
                </div>
            </div>
            <div class="quick-fill">
                <button class="quick-btn" onclick="quickFill('ç¾å­šæ–°é‚¨')">ç¾å­šæ–°é‚¨</button>
                <button class="quick-btn" onclick="quickFill('å¤ªå¤åŸ')">å¤ªå¤åŸ</button>
                <button class="quick-btn" onclick="quickFill('æ²™ç”°ç¬¬ä¸€åŸ')">æ²™ç”°ç¬¬ä¸€åŸ</button>
                <button class="quick-btn" onclick="quickFill('é»ƒåŸ”èŠ±åœ’')">é»ƒåŸ”èŠ±åœ’</button>
                <button class="quick-btn" onclick="loadSaved()">ğŸ“ ä¸Šæ¬¡ä½ç½®</button>
            </div>
            <p class="hint">ğŸ’¡ ç›´æ¥è¼¸å…¥æ‚¨çš„ä½ç½®ï¼Œç³»çµ±æœƒè‡ªå‹•åŒ¹é…å±‹è‹‘è³‡æ–™</p>
        </div>
    </section>

    <section class="section">
        <div class="section-title"><span class="num">2</span> æ‚¨çš„ç‹€æ…‹</div>
        <div class="status-btns">
            <button class="status-btn btn-safe" data-status="safe" onclick="selectStatus('safe')">âœ… æˆ‘å®‰å…¨äº†</button>
            <button class="status-btn btn-trapped" data-status="trapped" onclick="selectStatus('trapped')">ğŸš¨ æˆ‘è¢«å›°äº†</button>
            <button class="status-btn btn-help" data-status="help" onclick="selectStatus('help')">ğŸ†˜ éœ€è¦å¹«åŠ©</button>
        </div>
    </section>

    <section class="section">
        <div class="section-title"><span class="num">3</span> æ‹æ”ç’°å¢ƒï¼ˆé¸å¡«ï¼‰</div>
        <div class="photo-area">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">
            <button class="photo-btn" id="photoBtn" onclick="takePhoto()">ğŸ“· æ‹æ”å‘¨åœç’°å¢ƒï¼ˆå¹«åŠ©æ•‘æ´äººå“¡äº†è§£æƒ…æ³ï¼‰</button>
            <div class="photo-preview" id="photoPreview">
                <img id="previewImg" src="" alt="é è¦½">
                <button class="remove" onclick="removePhoto()">Ã—</button>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="section-title"><span class="num">4</span> å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <textarea id="noteInput" placeholder="ä¾‹å¦‚ï¼šæœ‰é•·è€…ã€æœ‰å°å­©ã€éœ€è¦è¼ªæ¤…ã€ç…™éœ§å¾ˆå¤§ã€è¢«å›°åœ¨å»æ‰€..."></textarea>
    </section>

    <div class="submit-container">
        <button class="submit-btn" id="submitBtn" onclick="submitReport()" disabled>ğŸ“¤ ç™¼é€å ±å‘Š</button>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">âœ…</div>
            <div class="modal-title" id="modalTitle">å ±å‘Šå·²ç™¼é€</div>
            <div class="modal-msg" id="modalMsg">æ‚¨çš„ä½ç½®å’Œç‹€æ…‹å·²æˆåŠŸç™¼é€çµ¦æ•‘æ´äººå“¡</div>
            <button class="modal-btn primary" onclick="closeAndGoHome()">è¿”å›é¦–é </button>
            <button class="modal-btn secondary" onclick="sendAnother()">ç™¼é€å¦ä¸€å€‹å ±å‘Š</button>
        </div>
    </div>

    <script src="estates-data.js"></script>
    <script>
    let selectedStatus = null;
    let photoData = null;
    let matchedEstateKey = null;
    let validationResult = null;

    document.addEventListener('DOMContentLoaded', function() {
        const inputs = ['inputEstate', 'inputBuilding', 'inputFloor', 'inputUnit'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                validateAndMatch();
                checkFormValidity();
            });
        });
        
        // ç‰¹åˆ¥è™•ç†å±‹è‹‘è¼¸å…¥çš„å³æ™‚åŒ¹é…
        document.getElementById('inputEstate').addEventListener('input', debounce(matchEstateInput, 300));
        document.getElementById('inputBuilding').addEventListener('input', debounce(validateBuilding, 300));
        document.getElementById('inputFloor').addEventListener('input', debounce(validateFloor, 300));
        
        updateNetworkStatus();
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(e => console.log('SW:', e));
        }
        
        tryLoadLastLocation();
    });

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function matchEstateInput() {
        const input = document.getElementById('inputEstate').value.trim();
        const hint = document.getElementById('estateHint');
        const inputEl = document.getElementById('inputEstate');
        
        if (!input) {
            hint.style.display = 'none';
            inputEl.classList.remove('success', 'error');
            matchedEstateKey = null;
            return;
        }
        
        const match = window.estatesManager.matchEstate(input);
        
        if (match) {
            matchedEstateKey = match.key;
            hint.textContent = `âœ“ å·²åŒ¹é…ï¼š${match.estate.name}`;
            hint.className = 'match-hint success';
            hint.style.display = 'block';
            inputEl.classList.add('success');
            inputEl.classList.remove('error');
        } else {
            matchedEstateKey = null;
            hint.textContent = 'âš  æœªæ‰¾åˆ°åŒ¹é…å±‹è‹‘ï¼Œå ±å‘Šå°‡ç”±æ¶ˆé˜²å“¡äººå·¥ç¢ºèª';
            hint.className = 'match-hint warning';
            hint.style.display = 'block';
            inputEl.classList.remove('success', 'error');
        }
    }

    function validateBuilding() {
        const building = document.getElementById('inputBuilding').value.trim();
        const hint = document.getElementById('buildingHint');
        const inputEl = document.getElementById('inputBuilding');
        
        if (!building || !matchedEstateKey) {
            hint.style.display = 'none';
            inputEl.classList.remove('success', 'error');
            return;
        }
        
        const estate = window.estatesManager.getEstate(matchedEstateKey);
        if (!estate) return;
        
        const matchedBuilding = estate.buildings.find(b => 
            b.name === building || b.name.includes(building) || building.includes(b.name)
        );
        
        if (matchedBuilding) {
            hint.textContent = `âœ“ å·²åŒ¹é…ï¼š${matchedBuilding.name}ï¼ˆå…±${matchedBuilding.floors}å±¤ï¼‰`;
            hint.className = 'match-hint success';
            hint.style.display = 'block';
            inputEl.classList.add('success');
            inputEl.classList.remove('error');
        } else {
            hint.textContent = 'âš  æœªæ‰¾åˆ°æ­¤å¤§å»ˆï¼Œå°‡ç”±æ¶ˆé˜²å“¡ç¢ºèª';
            hint.className = 'match-hint warning';
            hint.style.display = 'block';
            inputEl.classList.remove('success', 'error');
        }
    }

    function validateFloor() {
        const floor = document.getElementById('inputFloor').value.trim();
        const building = document.getElementById('inputBuilding').value.trim();
        const hint = document.getElementById('floorHint');
        const inputEl = document.getElementById('inputFloor');
        
        if (!floor) {
            hint.style.display = 'none';
            inputEl.classList.remove('success', 'error');
            return;
        }
        
        const floorNum = parseInt(floor.replace(/æ¨“|å±¤|F/gi, ''));
        
        if (isNaN(floorNum) || floorNum < 1) {
            hint.textContent = 'âœ— è«‹è¼¸å…¥æœ‰æ•ˆæ¨“å±¤';
            hint.className = 'match-hint error';
            hint.style.display = 'block';
            inputEl.classList.add('error');
            inputEl.classList.remove('success');
            return;
        }
        
        if (matchedEstateKey && building) {
            const estate = window.estatesManager.getEstate(matchedEstateKey);
            const matchedBuilding = estate?.buildings.find(b => 
                b.name === building || b.name.includes(building) || building.includes(b.name)
            );
            
            if (matchedBuilding && floorNum > matchedBuilding.floors) {
                hint.textContent = `âš  æ­¤å¤§å»ˆæœ€é«˜${matchedBuilding.floors}å±¤`;
                hint.className = 'match-hint warning';
                hint.style.display = 'block';
                inputEl.classList.remove('success', 'error');
                return;
            }
        }
        
        hint.textContent = `âœ“ ${floorNum}æ¨“`;
        hint.className = 'match-hint success';
        hint.style.display = 'block';
        inputEl.classList.add('success');
        inputEl.classList.remove('error');
    }

    function validateAndMatch() {
        const estate = document.getElementById('inputEstate').value.trim();
        const building = document.getElementById('inputBuilding').value.trim();
        const floor = document.getElementById('inputFloor').value.trim();
        const unit = document.getElementById('inputUnit').value.trim();
        
        if (matchedEstateKey && building && floor) {
            validationResult = window.estatesManager.validateLocation(matchedEstateKey, building, floor, unit);
        } else {
            validationResult = null;
        }
    }

    function quickFill(estate) {
        document.getElementById('inputEstate').value = estate;
        matchEstateInput();
        document.getElementById('inputBuilding').focus();
        checkFormValidity();
    }

    function loadSaved() {
        const saved = localStorage.getItem('last_location');
        if (saved) {
            const loc = JSON.parse(saved);
            document.getElementById('inputEstate').value = loc.estate || '';
            document.getElementById('inputBuilding').value = loc.building || '';
            document.getElementById('inputFloor').value = loc.floor || '';
            document.getElementById('inputUnit').value = loc.unit || '';
            matchEstateInput();
            validateBuilding();
            validateFloor();
            checkFormValidity();
            alert('âœ… å·²è¼‰å…¥ä¸Šæ¬¡ä½ç½®');
        } else {
            alert('âŒ æ²’æœ‰å„²å­˜çš„ä½ç½®è¨˜éŒ„');
        }
    }

    function tryLoadLastLocation() {
        const saved = localStorage.getItem('last_location');
        if (saved) {
            const loc = JSON.parse(saved);
            if (loc.estate) {
                document.getElementById('inputEstate').value = loc.estate;
                matchEstateInput();
            }
        }
    }

    function selectStatus(status) {
        selectedStatus = status;
        document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelector(`[data-status="${status}"]`).classList.add('selected');
        const msgs = { safe: 'å·²é¸æ“‡å®‰å…¨', trapped: 'å·²é¸æ“‡è¢«å›°', help: 'å·²é¸æ“‡éœ€è¦å¹«åŠ©' };
        speak(msgs[status]);
        checkFormValidity();
    }

    function takePhoto() { document.getElementById('cameraInput').click(); }

    function handlePhoto(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) { alert('âš ï¸ ç…§ç‰‡å¤ªå¤§ï¼ˆè¶…é5MBï¼‰ï¼Œè«‹é‡æ–°æ‹æ”'); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            photoData = e.target.result;
            document.getElementById('previewImg').src = photoData;
            document.getElementById('photoPreview').classList.add('show');
            document.getElementById('photoBtn').textContent = 'ğŸ“· é‡æ–°æ‹æ”';
        };
        reader.readAsDataURL(file);
    }

    function removePhoto() {
        photoData = null;
        document.getElementById('photoPreview').classList.remove('show');
        document.getElementById('photoBtn').textContent = 'ğŸ“· æ‹æ”å‘¨åœç’°å¢ƒï¼ˆå¹«åŠ©æ•‘æ´äººå“¡äº†è§£æƒ…æ³ï¼‰';
        document.getElementById('cameraInput').value = '';
    }

    function checkFormValidity() {
        const estate = document.getElementById('inputEstate').value.trim();
        const floor = document.getElementById('inputFloor').value.trim();
        const isValid = estate && floor && selectedStatus;
        document.getElementById('submitBtn').disabled = !isValid;
    }

    function submitReport() {
        const estate = document.getElementById('inputEstate').value.trim();
        const building = document.getElementById('inputBuilding').value.trim();
        const floor = document.getElementById('inputFloor').value.trim();
        const unit = document.getElementById('inputUnit').value.trim();
        const phone = document.getElementById('inputPhone').value.trim();
        const note = document.getElementById('noteInput').value.trim();
        
        // æœ€çµ‚é©—è­‰
        let isMatched = false;
        let needsManualReview = true;
        
        if (matchedEstateKey) {
            const result = window.estatesManager.validateLocation(matchedEstateKey, building, floor, unit);
            isMatched = result.valid;
            needsManualReview = !result.valid || result.needsManualReview;
        }
        
        const report = {
            id: Date.now(),
            estate: estate,
            estateKey: matchedEstateKey || null,
            building: building || 'æœªæŒ‡å®š',
            floor: floor,
            unit: unit || 'æœªæŒ‡å®š',
            phone: phone || null,
            status: selectedStatus,
            note: note,
            photo: photoData,
            timestamp: new Date().toISOString(),
            synced: navigator.onLine,
            // åŒ¹é…ç‹€æ…‹
            matched: isMatched,
            needsManualReview: needsManualReview,
            verified: false,
            verifiedBy: null,
            verifiedAt: null
        };
        
        saveReport(report);
        
        localStorage.setItem('last_location', JSON.stringify({ estate, building, floor, unit }));
        
        showSuccessModal(selectedStatus, needsManualReview);
        broadcastUpdate(report);
    }

    function saveReport(report) {
        const reports = JSON.parse(localStorage.getItem('fire_reports') || '[]');
        const existingIndex = reports.findIndex(r => r.id === report.id);
        if (existingIndex >= 0) {
            reports[existingIndex] = report;
        } else {
            reports.push(report);
        }
        localStorage.setItem('fire_reports', JSON.stringify(reports));
        
        if (!navigator.onLine) {
            const queue = JSON.parse(localStorage.getItem('upload_queue') || '[]');
            queue.push(report);
            localStorage.setItem('upload_queue', JSON.stringify(queue));
        }
    }

    function broadcastUpdate(report) {
        if ('BroadcastChannel' in window) {
            const ch = new BroadcastChannel('fire_safety_sync');
            ch.postMessage({ type: 'new_report', report });
        }
    }

    function showSuccessModal(status, needsReview) {
        const icons = { safe: 'âœ…', trapped: 'ğŸš¨', help: 'ğŸ†˜' };
        const titles = { safe: 'å ±å¹³å®‰æˆåŠŸ', trapped: 'è¢«å›°å ±å‘Šå·²ç™¼é€', help: 'æ±‚åŠ©å·²ç™¼é€' };
        let msg = '';
        if (status === 'safe') {
            msg = 'æ‚¨çš„å®‰å…¨ç‹€æ…‹å·²é€šçŸ¥å®¶äººå’Œæ•‘æ´äººå“¡';
        } else {
            msg = 'æ•‘æ´äººå“¡å·²æ”¶åˆ°æ‚¨çš„ä½ç½®ï¼Œè«‹ä¿æŒå†·éœç­‰å¾…æ•‘æ´';
        }
        if (needsReview) {
            msg += '\n\nï¼ˆä½ç½®è³‡æ–™å°‡ç”±æ¶ˆé˜²å“¡ç¢ºèªï¼‰';
        }
        if (!navigator.onLine) {
            msg += '\n\nï¼ˆé›¢ç·šæ¨¡å¼ï¼Œç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•ç™¼é€ï¼‰';
        }
        
        document.getElementById('modalIcon').textContent = icons[status];
        document.getElementById('modalTitle').textContent = titles[status];
        document.getElementById('modalMsg').textContent = msg;
        document.getElementById('successModal').classList.add('show');
        speak(titles[status]);
    }

    function closeAndGoHome() { window.location.href = 'index.html'; }

    function sendAnother() {
        const estate = document.getElementById('inputEstate').value;
        selectedStatus = null;
        photoData = null;
        document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('inputBuilding').value = '';
        document.getElementById('inputFloor').value = '';
        document.getElementById('inputUnit').value = '';
        document.getElementById('inputPhone').value = '';
        document.getElementById('noteInput').value = '';
        document.getElementById('photoPreview').classList.remove('show');
        document.getElementById('photoBtn').textContent = 'ğŸ“· æ‹æ”å‘¨åœç’°å¢ƒï¼ˆå¹«åŠ©æ•‘æ´äººå“¡äº†è§£æƒ…æ³ï¼‰';
        document.getElementById('cameraInput').value = '';
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('successModal').classList.remove('show');
        ['estateHint', 'buildingHint', 'floorHint'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById('inputEstate').value = estate;
        document.getElementById('inputBuilding').focus();
        window.scrollTo(0, 0);
    }

    function updateNetworkStatus() {
        const el = document.getElementById('netStatus');
        const bar = document.getElementById('offlineBar');
        if (navigator.onLine) {
            el.textContent = 'ğŸŸ¢ åœ¨ç·š';
            el.classList.remove('offline');
            bar.classList.remove('show');
            processUploadQueue();
        } else {
            el.textContent = 'ğŸ”´ é›¢ç·š';
            el.classList.add('offline');
            bar.classList.add('show');
        }
    }

    function processUploadQueue() {
        const queue = JSON.parse(localStorage.getItem('upload_queue') || '[]');
        if (queue.length > 0) {
            console.log('ä¸Šå‚³', queue.length, 'å€‹å¾…å‚³å ±å‘Š');
            localStorage.setItem('upload_queue', '[]');
        }
    }

    function speak(text) {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-HK';
            u.rate = 1.2;
            speechSynthesis.speak(u);
        }
    }
    </script>
</body>
</html>